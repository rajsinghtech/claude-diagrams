#!/bin/bash
# Pre-tool hook for claude-diagrams project
# Prevents accidental modifications to generated files

set -e

# Check for operations on public directory
if [[ "$TOOL_NAME" =~ ^(Write|Edit|MultiEdit|Bash)$ ]]; then
    # For file modification tools, check the file path
    if [[ -n "$FILE_PATH" && "$FILE_PATH" =~ /public/ ]]; then
        echo "‚ùå Error: Attempting to modify generated files in public/ directory"
        echo "üìù Please modify source files in content/ instead"
        echo "   The public/ directory is auto-generated by Hugo"
        exit 1
    fi
    
    # For Bash commands, check if they're trying to modify public/
    if [[ "$TOOL_NAME" == "Bash" && -n "$COMMAND" ]]; then
        # Check for common modification commands targeting public/
        if [[ "$COMMAND" =~ (rm|mv|cp|touch|mkdir|rmdir|>|>>).*/public/ ]] || \
           [[ "$COMMAND" =~ public/.*(>|>>) ]] || \
           [[ "$COMMAND" =~ ^(rm|mv|cp).*public/ ]]; then
            echo "‚ùå Error: Command would modify the public/ directory"
            echo "üìù The public/ directory is auto-generated by Hugo"
            echo "   Please modify source files in content/ instead"
            exit 1
        fi
    fi
fi

# Warn about creating new diagrams without proper structure
if [[ "$TOOL_NAME" == "Write" && "$FILE_PATH" =~ \.svg$ ]]; then
    # Check if it's in the correct location
    if [[ ! "$FILE_PATH" =~ content/diagrams/[^/]+/[^/]+/[^/]+\.svg$ ]]; then
        echo "‚ö†Ô∏è  Warning: Creating SVG outside standard structure"
        echo "üìÇ Expected: content/diagrams/[category]/[diagram-name]/[diagram-name].svg"
        echo "   Categories: architecture, flowcharts, network, system-design,"
        echo "              tailnet-topology, acl-flows, exit-node-architecture, subnet-routing"
        # Don't block, just warn
    fi
fi

# Check for Git config modifications (from CLAUDE.md: NEVER update git config)
if [[ "$TOOL_NAME" == "Bash" && "$COMMAND" =~ git\ config ]]; then
    echo "‚ùå Error: Git config modifications are not allowed"
    echo "   This restriction is defined in CLAUDE.md"
    exit 1
fi

exit 0