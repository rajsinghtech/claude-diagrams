<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Tailscale DERP Connection Establishment Flow | Claude Diagrams</title>
<meta name=generator content="Hugo 0.121.2"><link rel=stylesheet href=/claude-diagrams/css/main.min.6031f18919a5919243f3aef7c58df672be3052a45dd4517b8fc728761fda4de4.css></head><body><main><article class=diagram-single><header class=diagram-header><h1>Tailscale DERP Connection Establishment Flow</h1><p class=description>Detailed sequence diagram showing how Tailscale establishes connections using DERP servers and DISCO protocol</p><div class=metadata><time>July 24, 2025</time><div class=tags><a href=/claude-diagrams/tags/tailscale/ class=tag>#tailscale</a>
<a href=/claude-diagrams/tags/derp/ class=tag>#derp</a>
<a href=/claude-diagrams/tags/disco/ class=tag>#disco</a>
<a href=/claude-diagrams/tags/connection-establishment/ class=tag>#connection-establishment</a>
<a href=/claude-diagrams/tags/wireguard/ class=tag>#wireguard</a>
<a href=/claude-diagrams/tags/nat-traversal/ class=tag>#nat-traversal</a></div></div></header><div class=diagram-container></div><div class=diagram-description><h2 id=overview>Overview</h2><p>This diagram shows the detailed connection establishment flow in Tailscale, including DERP home selection, DISCO protocol messages, and the transition from relayed to direct connections.</p><div class=mermaid-wrapper><pre class=mermaid>sequenceDiagram
    participant NodeA as Node A<br>100.64.1.10
    participant Coord as Coordination<br>Server
    participant DERP1 as DERP nyc<br>(Nearest)
    participant DERP2 as DERP fra<br>(Node B Home)
    participant NodeB as Node B<br>100.64.2.20
    
    Note over NodeA,NodeB: Initial Setup Phase
    NodeA->>Coord: Get DERP Map
    Coord-->>NodeA: DERP Server List
    NodeA->>DERP1: Latency Test
    NodeA->>DERP2: Latency Test
    NodeA->>DERP1: Select as DERP Home
    
    NodeB->>Coord: Get DERP Map
    Coord-->>NodeB: DERP Server List
    NodeB->>DERP2: Select as DERP Home
    
    Note over NodeA,NodeB: Connection Establishment
    NodeA->>Coord: Request to connect to Node B
    Coord-->>NodeA: Node B info + DERP Home (fra)
    
    NodeA->>DERP1: Connect (TLS)
    NodeA->>DERP2: Connect to Node B's DERP
    
    NodeA->>DERP2: DISCO Ping (encrypted)
    DERP2->>NodeB: Relay DISCO Ping
    NodeB-->>DERP2: DISCO Pong
    DERP2-->>NodeA: Relay DISCO Pong
    
    Note over NodeA,NodeB: NAT Traversal via DISCO
    NodeA->>NodeB: Direct DISCO Ping<br>(multiple endpoints)
    NodeB->>NodeA: Direct DISCO Ping<br>(multiple endpoints)
    
    NodeA->>DERP2: CallMeMaybe message
    DERP2->>NodeB: Relay CallMeMaybe
    NodeB->>NodeA: Attempt direct connection
    
    Note over NodeA,NodeB: Connection Upgrade
    NodeA<->NodeB: Direct WireGuard tunnel established
    NodeA--xDERP2: Close relay connection<br>(optional, kept as fallback)
    
    style Coord fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    style DERP1 fill:#f5f5f5,stroke:#455a64,stroke-width:2px,color:#000
    style DERP2 fill:#f5f5f5,stroke:#455a64,stroke-width:2px,color:#000
  </pre></div><style>.mermaid-wrapper{background:#2a2a2a;border-radius:8px;padding:2rem;margin:1rem 0;overflow-x:auto}.mermaid{text-align:center;background:0 0}.mermaid svg{max-width:100%;height:auto}</style><h2 id=protocol-details>Protocol Details</h2><h3 id=disco-messages>DISCO Messages</h3><ul><li><strong>DISCO Ping</strong>: Contains transaction ID + sender&rsquo;s WireGuard public key</li><li><strong>DISCO Pong</strong>: Returns sender&rsquo;s observed IP:port (STUN-like functionality)</li><li><strong>CallMeMaybe</strong>: Requests recipient to initiate connection back to sender</li></ul><h3 id=connection-states>Connection States</h3><ol><li><strong>DERP Home Selection</strong>: Each node selects nearest DERP based on latency</li><li><strong>Initial Relay</strong>: All traffic flows through DERP servers</li><li><strong>Parallel Discovery</strong>: DISCO protocol attempts direct connection</li><li><strong>Connection Upgrade</strong>: Seamless switch to direct P2P when successful</li></ol></div></article><style>.diagram-single{max-width:1200px;margin:0 auto;padding:2rem}.diagram-header{margin-bottom:2rem;text-align:center}.diagram-header h1{font-size:2.5rem;margin-bottom:1rem}.description{font-size:1.2rem;color:var(--text-secondary);margin-bottom:1rem}.metadata{display:flex;justify-content:center;align-items:center;gap:2rem;color:var(--text-secondary);font-size:.9rem}.tags{display:flex;gap:.5rem}.tag{background:var(--bg-secondary);padding:.25rem .75rem;border-radius:9999px;text-decoration:none;color:var(--text-secondary);transition:all .3s}.tag:hover{background:var(--accent);color:#fff}.diagram-container{background:var(--bg-secondary);border-radius:8px;padding:2rem;margin:2rem 0;overflow:auto}.svg-wrapper{display:flex;justify-content:center;align-items:center;min-height:400px}.svg-wrapper svg{max-width:100%;height:auto}.diagram-description{margin-top:2rem;font-size:1.1rem;line-height:1.8}</style></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#1a1a1a',
        primaryTextColor: '#ffffff',
        primaryBorderColor: '#ffffff',
        lineColor: '#ffffff',
        secondaryColor: '#2196f3',
        tertiaryColor: '#4caf50',
        background: '#1a1a1a',
        mainBkg: '#2a2a2a',
        secondBkg: '#2196f3',
        tertiaryBkg: '#4caf50',
        secondaryBorderColor: '#ffffff',
        tertiaryBorderColor: '#ffffff',
        secondaryTextColor: '#ffffff',
        tertiaryTextColor: '#ffffff',
        edgeLabelBackground: '#2a2a2a',
        nodeTextColor: '#ffffff',
        textColor: '#ffffff',
        titleColor: '#ffffff',
        labelTextColor: '#ffffff',
        actorBorder: '#ffffff',
        actorBkg: '#2a2a2a',
        actorTextColor: '#ffffff',
        actorLineColor: '#ffffff',
        signalColor: '#ffffff',
        signalTextColor: '#ffffff',
        labelBoxBkgColor: '#2a2a2a',
        labelBoxBorderColor: '#ffffff',
        noteBkgColor: '#3a3a3a',
        noteTextColor: '#ffffff',
        noteBorderColor: '#ffffff',
        activationBorderColor: '#ffffff',
        activationBkgColor: '#3a3a3a',
        sequenceNumberColor: '#000000',
        fontFamily: 'Inter, system-ui, -apple-system, sans-serif',
        fontSize: '16px',
        darkMode: true,
        flowchart: {
          htmlLabels: true,
          curve: 'basis',
          rankSpacing: 50,
          nodeSpacing: 30,
          padding: 15,
          useMaxWidth: true
        }
      }
    });
  </script></body></html>