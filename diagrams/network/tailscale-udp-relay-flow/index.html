<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Basic DERP Relay Flow | Claude Diagrams</title>
<meta name=generator content="Hugo 0.121.2"><link rel=stylesheet href=/claude-diagrams/css/main.min.6031f18919a5919243f3aef7c58df672be3052a45dd4517b8fc728761fda4de4.css></head><body><main><article class=diagram-single><header class=diagram-header><h1>Basic DERP Relay Flow</h1><p class=description>Visualizing how Tailscale uses DERP servers for UDP relay and connection establishment</p><div class=metadata><time>July 24, 2025</time><div class=tags><a href=/claude-diagrams/tags/tailscale/ class=tag>#tailscale</a>
<a href=/claude-diagrams/tags/derp/ class=tag>#derp</a>
<a href=/claude-diagrams/tags/udp/ class=tag>#udp</a>
<a href=/claude-diagrams/tags/relay/ class=tag>#relay</a>
<a href=/claude-diagrams/tags/nat-traversal/ class=tag>#nat-traversal</a>
<a href=/claude-diagrams/tags/mesh-vpn/ class=tag>#mesh-vpn</a>
<a href=/claude-diagrams/tags/p2p/ class=tag>#p2p</a></div></div></header><div class=diagram-container><div class=svg-wrapper><svg viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg"><defs><marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto"><polygon points="0,0 10,5 0,10" fill="#000"/></marker><marker id="arrowhead-grey" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto"><polygon points="0,0 10,5 0,10" fill="#6b7280"/></marker><marker id="arrowhead-double" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto"><polygon points="0,0 10,5 0,10" fill="#000"/></marker></defs><title>Basic DERP Relay Flow</title><desc>Visualizing how Tailscale uses DERP servers for UDP relay and connection establishment</desc><rect width="900" height="600" fill="#fff"/><text x="450" y="30" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="20" font-weight="600" fill="#000">Basic DERP Relay Flow</text><g id="node-a-network"><rect x="50" y="150" width="200" height="300" fill="#f5f5f5" stroke="#e5e7eb" stroke-width="1" rx="5"/><text x="150" y="130" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="500" fill="#374151">Node A Network</text><rect x="80" y="250" width="140" height="80" fill="#1976d2" stroke="#fff" stroke-width="2" rx="5"/><text x="150" y="275" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="500" fill="#fff">Node A</text><text x="150" y="295" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="400" fill="#fff">100.64.1.10</text><text x="150" y="315" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" font-weight="400" fill="#fff">Behind NAT</text></g><g id="derp-infrastructure"><rect x="350" y="100" width="200" height="400" fill="#fef3e2" stroke="#fed7aa" stroke-width="1" rx="5"/><text x="450" y="80" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="500" fill="#374151">DERP Infrastructure</text><rect x="380" y="250" width="140" height="80" fill="#f57c00" stroke="#fff" stroke-width="2" rx="5" stroke-dasharray="5,3"/><text x="450" y="275" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="500" fill="#fff">DERP Server</text><text x="450" y="295" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="400" fill="#fff">nyc.derp.example</text><text x="450" y="315" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" font-weight="400" fill="#fff">Relay Only</text></g><g id="node-b-network"><rect x="650" y="150" width="200" height="300" fill="#f5f5f5" stroke="#e5e7eb" stroke-width="1" rx="5"/><text x="750" y="130" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="500" fill="#374151">Node B Network</text><rect x="680" y="250" width="140" height="80" fill="#1976d2" stroke="#fff" stroke-width="2" rx="5"/><text x="750" y="275" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="500" fill="#fff">Node B</text><text x="750" y="295" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="12" font-weight="400" fill="#fff">100.64.2.20</text><text x="750" y="315" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" font-weight="400" fill="#fff">Behind NAT</text></g><g id="connections"><path d="M220 270q80-40 160 0" fill="none" stroke="#6b7280" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead-grey)"/><rect x="240" y="220" width="120" height="40" fill="#fff" stroke="none"/><text x="300" y="235" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" fill="#374151">1. Initial Connection</text><text x="300" y="250" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" fill="#374151">via DERP</text><path d="M520 290q80-40 160 0" fill="none" stroke="#6b7280" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead-grey)"/><rect x="540" y="220" width="120" height="40" fill="#fff" stroke="none"/><text x="600" y="235" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" fill="#374151">2. Relay Encrypted</text><text x="600" y="250" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" fill="#374151">WireGuard Traffic</text><path d="M220 330q230 90 460 0" fill="none" stroke="#ff9800" stroke-width="2" stroke-dasharray="2,2" marker-end="url(#arrowhead)"/><rect x="380" y="410" width="140" height="55" fill="#fff" stroke="none"/><text x="450" y="425" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" fill="#374151">3. Attempt Direct</text><text x="450" y="440" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" fill="#374151">Connection</text><text x="450" y="455" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" fill="#374151">NAT Traversal</text><line x1="220" y1="290" x2="680" y2="290" stroke="#000" stroke-width="3" marker-end="url(#arrowhead-double)"/><rect x="380" y="345" width="140" height="55" fill="#fff" stroke="none"/><text x="450" y="360" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" font-weight="500" fill="#000">4. Upgrade to Direct</text><text x="450" y="375" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" font-weight="500" fill="#000">P2P Connection</text><text x="450" y="390" text-anchor="middle" font-family="Inter, Arial, sans-serif" font-size="11" font-weight="500" fill="#000">When Successful</text></g><g id="legend"><text x="50" y="510" font-family="Inter, Arial, sans-serif" font-size="14" font-weight="600" fill="#000">Connection Types:</text><line x1="50" y1="535" x2="90" y2="535" stroke="#000" stroke-width="3"/><text x="100" y="540" font-family="Inter, Arial, sans-serif" font-size="12" fill="#374151">Active data flow (WireGuard encrypted)</text><line x1="350" y1="535" x2="390" y2="535" stroke="#6b7280" stroke-width="2" stroke-dasharray="5,3"/><text x="400" y="540" font-family="Inter, Arial, sans-serif" font-size="12" fill="#374151">DERP relay connections</text><line x1="50" y1="560" x2="90" y2="560" stroke="#ff9800" stroke-width="2" stroke-dasharray="2,2"/><text x="100" y="565" font-family="Inter, Arial, sans-serif" font-size="12" fill="#374151">NAT traversal attempts</text><text x="350" y="565" font-family="Inter, Arial, sans-serif" font-size="12" fill="#374151">Upgraded direct P2P connection</text></g></svg></div></div><div class=diagram-description><h2 id=overview>Overview</h2><p>This diagram illustrates the basic DERP relay flow in Tailscale, showing how DERP (Designated Encrypted Relay Points) servers facilitate connection establishment and serve as fallback relays when direct peer-to-peer connections are not possible.</p><div class=mermaid-wrapper><pre class=mermaid>graph TD
    subgraph "Node A Network"
        NodeA[Node A<br>100.64.1.10<br>Behind NAT]
    end
    
    subgraph "DERP Infrastructure"
        DERP[DERP Server<br>nyc.derp.example<br>Relay Only]
    end
    
    subgraph "Node B Network"
        NodeB[Node B<br>100.64.2.20<br>Behind NAT]
    end
    
    subgraph "Connection Flow"
        NodeA -->|1. Initial Connection<br>via DERP| DERP
        DERP -->|2. Relay Encrypted<br>WireGuard Traffic| NodeB
        NodeA -.->|3. Attempt Direct<br>Connection<br>NAT Traversal| NodeB
        NodeA ==>|4. Upgrade to Direct<br>P2P Connection<br>When Successful| NodeB
    end
    
    style NodeA fill:#1976d2,stroke:#fff,stroke-width:2px,color:#fff
    style NodeB fill:#1976d2,stroke:#fff,stroke-width:2px,color:#fff
    style DERP fill:#f57c00,stroke:#fff,stroke-width:2px,color:#fff
    
    classDef relay stroke-dasharray: 5 5
    class DERP relay
  </pre></div><style>.mermaid-wrapper{background:#2a2a2a;border-radius:8px;padding:2rem;margin:1rem 0;overflow-x:auto}.mermaid{text-align:center;background:0 0}.mermaid svg{max-width:100%;height:auto}</style><h2 id=key-points>Key Points</h2><ol><li><strong>Initial Connection</strong>: All connections start through DERP for instant connectivity</li><li><strong>Encrypted Relay</strong>: DERP servers only relay encrypted WireGuard packets, they cannot decrypt the traffic</li><li><strong>Parallel Discovery</strong>: While maintaining DERP connection, nodes attempt direct NAT traversal</li><li><strong>Transparent Upgrade</strong>: When direct connection succeeds, traffic seamlessly switches from relay to P2P</li></ol><h2 id=connection-types>Connection Types</h2><ul><li><strong>Solid Lines</strong>: Active data flow</li><li><strong>Dashed Lines</strong>: NAT traversal attempts</li><li><strong>Double Lines</strong>: Upgraded direct P2P connection</li></ul></div></article><style>.diagram-single{max-width:1200px;margin:0 auto;padding:2rem}.diagram-header{margin-bottom:2rem;text-align:center}.diagram-header h1{font-size:2.5rem;margin-bottom:1rem}.description{font-size:1.2rem;color:var(--text-secondary);margin-bottom:1rem}.metadata{display:flex;justify-content:center;align-items:center;gap:2rem;color:var(--text-secondary);font-size:.9rem}.tags{display:flex;gap:.5rem}.tag{background:var(--bg-secondary);padding:.25rem .75rem;border-radius:9999px;text-decoration:none;color:var(--text-secondary);transition:all .3s}.tag:hover{background:var(--accent);color:#fff}.diagram-container{background:var(--bg-secondary);border-radius:8px;padding:2rem;margin:2rem 0;overflow:auto}.svg-wrapper{display:flex;justify-content:center;align-items:center;min-height:400px}.svg-wrapper svg{max-width:100%;height:auto}.diagram-description{margin-top:2rem;font-size:1.1rem;line-height:1.8}</style></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#1a1a1a',
        primaryTextColor: '#ffffff',
        primaryBorderColor: '#ffffff',
        lineColor: '#ffffff',
        secondaryColor: '#2196f3',
        tertiaryColor: '#4caf50',
        background: '#1a1a1a',
        mainBkg: '#2a2a2a',
        secondBkg: '#2196f3',
        tertiaryBkg: '#4caf50',
        secondaryBorderColor: '#ffffff',
        tertiaryBorderColor: '#ffffff',
        secondaryTextColor: '#ffffff',
        tertiaryTextColor: '#ffffff',
        edgeLabelBackground: '#2a2a2a',
        nodeTextColor: '#ffffff',
        textColor: '#ffffff',
        titleColor: '#ffffff',
        labelTextColor: '#ffffff',
        actorBorder: '#ffffff',
        actorBkg: '#2a2a2a',
        actorTextColor: '#ffffff',
        actorLineColor: '#ffffff',
        signalColor: '#ffffff',
        signalTextColor: '#ffffff',
        labelBoxBkgColor: '#2a2a2a',
        labelBoxBorderColor: '#ffffff',
        noteBkgColor: '#3a3a3a',
        noteTextColor: '#ffffff',
        noteBorderColor: '#ffffff',
        activationBorderColor: '#ffffff',
        activationBkgColor: '#3a3a3a',
        sequenceNumberColor: '#000000',
        fontFamily: 'Inter, system-ui, -apple-system, sans-serif',
        fontSize: '16px',
        darkMode: true,
        flowchart: {
          htmlLabels: true,
          curve: 'basis',
          rankSpacing: 50,
          nodeSpacing: 30,
          padding: 15,
          useMaxWidth: true
        }
      }
    });
  </script></body></html>