<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Tailscale NAT Traversal and Fallback Mechanism | Claude Diagrams</title>
<meta name=generator content="Hugo 0.121.2"><link rel=stylesheet href=/claude-diagrams/css/main.min.6031f18919a5919243f3aef7c58df672be3052a45dd4517b8fc728761fda4de4.css></head><body><main><article class=diagram-single><header class=diagram-header><h1>Tailscale NAT Traversal and Fallback Mechanism</h1><p class=description>Comprehensive diagram showing Tailscale's multi-technique NAT traversal approach and fallback to DERP relay</p><div class=metadata><time>July 24, 2025</time><div class=tags><a href=/claude-diagrams/tags/tailscale/ class=tag>#tailscale</a>
<a href=/claude-diagrams/tags/nat-traversal/ class=tag>#nat-traversal</a>
<a href=/claude-diagrams/tags/stun/ class=tag>#stun</a>
<a href=/claude-diagrams/tags/upnp/ class=tag>#upnp</a>
<a href=/claude-diagrams/tags/derp/ class=tag>#derp</a>
<a href=/claude-diagrams/tags/fallback/ class=tag>#fallback</a>
<a href=/claude-diagrams/tags/cgnat/ class=tag>#cgnat</a>
<a href=/claude-diagrams/tags/firewall/ class=tag>#firewall</a></div></div></header><div class=diagram-container></div><div class=diagram-description><h2 id=overview>Overview</h2><p>This diagram illustrates Tailscale&rsquo;s sophisticated NAT traversal techniques and the decision flow for using direct connections versus DERP relay fallback.</p><div class=mermaid-wrapper><pre class=mermaid>graph TD
    Start[Connection Request] --> GetInfo[Gather Network Info]
    
    GetInfo --> STUN[STUN Discovery<br>Get Public IP:Port]
    GetInfo --> UPnP[Try UPnP/NAT-PMP<br>Port Mapping]
    GetInfo --> Local[Detect Local<br>Network Interfaces]
    
    STUN --> Analysis{Analyze NAT Type}
    UPnP --> Analysis
    Local --> Analysis
    
    Analysis -->|Easy NAT| EasyNAT[Full Cone NAT<br>or Port Restricted]
    Analysis -->|Hard NAT| HardNAT[Symmetric NAT<br>or CGNAT]
    Analysis -->|No UDP| NoUDP[UDP Blocked<br>TCP Only]
    
    EasyNAT --> DirectAttempt[Attempt Direct<br>Connection]
    HardNAT --> AdvancedNAT[Advanced NAT<br>Traversal]
    
    DirectAttempt --> SimulTX[Simultaneous<br>Transmission]
    SimulTX --> DISCO[DISCO Protocol<br>Endpoint Discovery]
    
    AdvancedNAT --> Birthday[Birthday Paradox<br>Port Prediction]
    AdvancedNAT --> MultiPath[Try Multiple<br>Source Ports]
    Birthday --> DISCO
    MultiPath --> DISCO
    
    DISCO --> Success{Connection<br>Established?}
    
    Success -->|Yes| Direct[Direct P2P<br>WireGuard Tunnel<br>✓ Low Latency<br>✓ High Throughput]
    Success -->|No| DERPRelay[DERP Relay<br>Fallback<br>○ Reliable<br>○ Higher Latency]
    
    NoUDP --> DERPRelay
    
    DERPRelay --> Monitor[Monitor for<br>Network Changes]
    Monitor --> Retry[Periodic Retry<br>Direct Connection]
    Retry --> DirectAttempt
    
    style Start fill:#1976d2,stroke:#fff,stroke-width:2px,color:#fff
    style Direct fill:#388e3c,stroke:#fff,stroke-width:2px,color:#fff
    style DERPRelay fill:#f57c00,stroke:#fff,stroke-width:2px,color:#fff
    style NoUDP fill:#d32f2f,stroke:#fff,stroke-width:2px,color:#fff
    
    classDef technique fill:#e3f2fd,stroke:#1976d2,stroke-width:1px,color:#000
    class STUN,UPnP,Local,SimulTX,Birthday,MultiPath technique
    
    classDef decision fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    class Analysis,Success decision
  </pre></div><style>.mermaid-wrapper{background:#2a2a2a;border-radius:8px;padding:2rem;margin:1rem 0;overflow-x:auto}.mermaid{text-align:center;background:0 0}.mermaid svg{max-width:100%;height:auto}</style><h2 id=nat-traversal-techniques>NAT Traversal Techniques</h2><h3 id=primary-methods>Primary Methods</h3><ol><li><p><strong>STUN (Session Traversal Utilities for NAT)</strong></p><ul><li>Discovers public IP and port mappings</li><li>Identifies NAT behavior characteristics</li></ul></li><li><p><strong>Simultaneous Transmission</strong></p><ul><li>Both peers send packets at the same time</li><li>Opens bidirectional firewall holes</li></ul></li><li><p><strong>Port Mapping Protocols</strong></p><ul><li>UPnP (Universal Plug and Play)</li><li>NAT-PMP (NAT Port Mapping Protocol)</li><li>Creates persistent port forwards</li></ul></li></ol><h3 id=advanced-techniques>Advanced Techniques</h3><ol><li><p><strong>Birthday Paradox</strong></p><ul><li>Statistical approach for symmetric NATs</li><li>Tries multiple port combinations</li></ul></li><li><p><strong>Multi-Path Probing</strong></p><ul><li>Tests various source ports</li><li>Increases connection success probability</li></ul></li></ol><h3 id=fallback-strategy>Fallback Strategy</h3><p>When all NAT traversal techniques fail, Tailscale falls back to DERP relay:</p><ul><li><strong>Instant Connectivity</strong>: No connection failures from user perspective</li><li><strong>Continuous Optimization</strong>: Keeps trying direct connection in background</li><li><strong>Seamless Transition</strong>: Switches to direct when possible without disruption</li></ul><h2 id=network-scenarios>Network Scenarios</h2><ul><li><strong>Easy NAT</strong>: Full cone or restricted cone NAT - usually succeeds with basic techniques</li><li><strong>Hard NAT</strong>: Symmetric NAT or CGNAT - requires advanced techniques</li><li><strong>No UDP</strong>: Corporate firewalls blocking UDP - must use DERP over HTTPS/TCP</li></ul></div></article><style>.diagram-single{max-width:1200px;margin:0 auto;padding:2rem}.diagram-header{margin-bottom:2rem;text-align:center}.diagram-header h1{font-size:2.5rem;margin-bottom:1rem}.description{font-size:1.2rem;color:var(--text-secondary);margin-bottom:1rem}.metadata{display:flex;justify-content:center;align-items:center;gap:2rem;color:var(--text-secondary);font-size:.9rem}.tags{display:flex;gap:.5rem}.tag{background:var(--bg-secondary);padding:.25rem .75rem;border-radius:9999px;text-decoration:none;color:var(--text-secondary);transition:all .3s}.tag:hover{background:var(--accent);color:#fff}.diagram-container{background:var(--bg-secondary);border-radius:8px;padding:2rem;margin:2rem 0;overflow:auto}.svg-wrapper{display:flex;justify-content:center;align-items:center;min-height:400px}.svg-wrapper svg{max-width:100%;height:auto}.diagram-description{margin-top:2rem;font-size:1.1rem;line-height:1.8}</style></main><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#1a1a1a',
        primaryTextColor: '#ffffff',
        primaryBorderColor: '#ffffff',
        lineColor: '#ffffff',
        secondaryColor: '#2196f3',
        tertiaryColor: '#4caf50',
        background: '#1a1a1a',
        mainBkg: '#2a2a2a',
        secondBkg: '#2196f3',
        tertiaryBkg: '#4caf50',
        secondaryBorderColor: '#ffffff',
        tertiaryBorderColor: '#ffffff',
        secondaryTextColor: '#ffffff',
        tertiaryTextColor: '#ffffff',
        edgeLabelBackground: '#2a2a2a',
        nodeTextColor: '#ffffff',
        textColor: '#ffffff',
        titleColor: '#ffffff',
        labelTextColor: '#ffffff',
        actorBorder: '#ffffff',
        actorBkg: '#2a2a2a',
        actorTextColor: '#ffffff',
        actorLineColor: '#ffffff',
        signalColor: '#ffffff',
        signalTextColor: '#ffffff',
        labelBoxBkgColor: '#2a2a2a',
        labelBoxBorderColor: '#ffffff',
        noteBkgColor: '#3a3a3a',
        noteTextColor: '#ffffff',
        noteBorderColor: '#ffffff',
        activationBorderColor: '#ffffff',
        activationBkgColor: '#3a3a3a',
        sequenceNumberColor: '#000000',
        fontFamily: 'Inter, system-ui, -apple-system, sans-serif',
        fontSize: '16px',
        darkMode: true,
        flowchart: {
          htmlLabels: true,
          curve: 'basis',
          rankSpacing: 50,
          nodeSpacing: 30,
          padding: 15,
          useMaxWidth: true
        }
      }
    });
  </script></body></html>